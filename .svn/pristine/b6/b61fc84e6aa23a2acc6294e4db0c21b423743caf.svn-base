<template>
    <view :style="{ height: contentHeight + 'px' }" class="page-container">
        <view class="mine-cap">
            <view class="cap-title">{{ $t('common.mine') }}</view>
            <view class="cap-set-chunk">
                <view class="name">{{ GlobalStore.userInfo.username }}</view>
                <view class="set-wrap flex">
                    <view class="set-item" @click="updatePass">{{ $t('common.mine.XGMM') }}</view>
                    <view class="set-item" @click="loginOutWay">{{ $t('common.mine.TC') }}</view>
                </view>
            </view>
        </view>
        <view class="bottom-wrap">
            <view class="test0" @click="toCus">去客户端</view>
            <view class="set-item-wrap">
                <view class="item-title">{{ $t('staff.mine.key_DBX') }}</view>
                <view class="set-item-box">
                    <view class="set-item" v-for="(item, index) in todoList" :key="index" @click="handleTodo(index)">
                        <view class="set-item-num">{{ item.num }}</view>
                        <view class="set-item-title">{{ item.title }}</view>
                    </view>
                </view>
            </view>
            <view class="set-item-wrap">
                <view class="item-title">{{ $t('common.home') }}</view>
                <view class="set-item-box">
                    <view
                        class="set-item"
                        v-for="(item, index) in myProjectStatistics"
                        :key="index"
                        @click="handlePro(index)"
                    >
                        <view class="set-item-num">{{ item.num }}</view>
                        <view class="set-item-title">{{ item.title }}</view>
                    </view>
                </view>
            </view>
        </view>
        <!-- 修改密码 弹窗 -->
        <uni-popup @touchmove.stop.prevent :animation="true" ref="upDateRef" type="bottom" :is-mask-click="false">
            <view class="update-popup bottom-popup">
                <view class="close-popup" @click="closePop"></view>
                <view class="popup_title">{{ $t('common.mine.XGMM') }}</view>
                <view class="form-item">
                    <view class="label required">{{ $t('common.mine.XGMM_YSMM') }}</view>
                    <view class="input-wrap">
                        <input
                            v-model="oldPwd"
                            class="uni-input"
                            placeholder-class="ph"
                            :placeholder="$t('common.placeholder')"
                        />
                    </view>
                </view>
                <view class="form-item">
                    <view class="label required">{{ $t('common.mine.XGMM_XMM') }}</view>
                    <view class="input-wrap">
                        <input
                            v-model="newPwd"
                            class="uni-input"
                            placeholder-class="ph"
                            :placeholder="$t('common.placeholder')"
                        />
                    </view>
                </view>
                <view class="form-item">
                    <view class="label required">{{ $t('common.mine.XGMM_QRXMM') }}</view>
                    <view class="input-wrap">
                        <input
                            v-model="confirmPwd"
                            class="uni-input"
                            placeholder-class="ph"
                            :placeholder="$t('common.placeholder')"
                        />
                    </view>
                </view>
                <view class="btn-wrap">
                    <button class="btn cancel" @click="closePop">{{ $t('common.cancel') }}</button>
                    <view class="btn">
                        <LockButton :onClick="saveUpdate">{{ $t('common.save') }}</LockButton>
                    </view>
                </view>
            </view>
        </uni-popup>

        <!-- 提示弹窗 -->
        <uni-popup @touchmove.stop.prevent :animation="true" ref="tipsRef" type="center" :is-mask-click="false">
            <view class="tips-popup">
                <view class="close-popup"></view>
                <view class="title">{{ $t('staff.pro.updateProgress_tip_label') }}</view>
                <view class="text">{{ $t('common.mine.TC_tip') }}</view>

                <view class="btn-box">
                    <view class="btn cancel" @click="cancel">{{ $t('common.cancel') }}</view>
                    <view class="btn sure" @click="sure">{{ $t('common.text.QD') }}</view>
                </view>
            </view>
        </uni-popup>
    </view>
</template>
<script setup lang="ts">
    import { reactive, ref } from 'vue';
    import { useContentHeight } from '@/hooks/useContentHeight';
    import LockButton from '@/components/LockButton/index.vue';
    import { useGlobalStore } from '@/stores/index';
    import API from '@/apis/index';
    import { i18n } from '@/main';
    import { aesEncrypt } from '@/utils/crypt';
    import { navigateTo, switchTab } from '@/utils/navigate';
    import { useFilterStore } from '@/stores/filter';
    import { onShow } from '@dcloudio/uni-app';

    const filterStore = useFilterStore();
    const GlobalStore = useGlobalStore();

    const { contentHeight } = useContentHeight();

    const upDateRef = ref<any>(null);

    const toCus = () => {
        uni.navigateTo({
            url: '/pages/packageCustomer/index/index',
        });
    };
    const tipsRef = ref<any>(null);
    const loginOutWay = () => {
        tipsRef.value.open();
    };
    const sure = async () => {
        tipsRef.value.close();
        loginOut();
    };
    const cancel = () => {
        tipsRef.value.close();
    };
    const loginOut = async () => {
        await API.EMP_logout({
            token: GlobalStore.token,
        });
        GlobalStore.loginOut();
    };

    const oldPwd = ref('');
    const newPwd = ref('');
    const confirmPwd = ref('');
    const updatePass = () => {
        console.log('updatePass');
        upDateRef.value.open();
        uni.hideTabBar();
    };
    const closePop = () => {
        upDateRef.value.close();
        uni.showTabBar();
    };
    const saveUpdate = async () => {
        // console.log('saveUpdate');
        // closePop();
        if (!oldPwd.value) {
            uni.showToast({
                title: i18n.global.t('common.mine.XGMM_YSMM_tip'),
                icon: 'none',
            });
            return;
        }
        if (!newPwd.value) {
            uni.showToast({
                title: i18n.global.t('common.mine.XGMM_XMM_tip'),
                icon: 'none',
            });
            return;
        }
        if (!confirmPwd.value) {
            uni.showToast({
                title: i18n.global.t('common.mine.XGMM_QRXMM_tip'),
                icon: 'none',
            });
            return;
        }

        if (newPwd.value !== confirmPwd.value) {
            uni.showToast({
                title: i18n.global.t('common.mine.XGMM_tip'),
                icon: 'none',
            });
            return;
        }

        try {
            await API.EMP_updatePwd({
                oldPwd: aesEncrypt(oldPwd.value),
                newPwd: aesEncrypt(newPwd.value),
                confirmPwd: aesEncrypt(confirmPwd.value),
            });
            closePop();
            uni.showToast({
                title: i18n.global.t('common.mine.XGMM_success'),
                icon: 'none',
            });
            setTimeout(() => {
                loginOut();
            }, 1000);
        } catch {
            console.log('error');
        }
    };

    const fetchWay1 = () => {
        return API.EMP_myProjectStatistics();
    };
    const fetchWay2 = () => {
        return API.EMP_todo();
    };

    interface TodoItem {
        title: string;
        num: number;
    }

    const todoList = reactive<TodoItem[]>([
        {
            title: i18n.global.t('staff.mine.key_YQYJ'),
            num: 0,
        },
        {
            title: i18n.global.t('staff.mine.key_ZGZ'),
            num: 0,
        },
    ]);

    const myProjectStatistics = reactive<TodoItem[]>([
        {
            title: i18n.global.t('common.pro.state_1'),
            num: 0,
        },
        {
            title: i18n.global.t('common.pro.state_2'),
            num: 0,
        },
        {
            title: i18n.global.t('common.pro.state_3'),
            num: 0,
        },
        {
            title: i18n.global.t('common.pro.state_4'),
            num: 0,
        },
    ]);
    const handleTodo = (index: number) => {
        if (index === 0) {
            navigateTo({
                url: '/pages/todoList/delay',
            });
        } else if (index === 1) {
            navigateTo({
                url: '/pages/todoList/abarbeitung',
            });
        }
    };
    const handlePro = (index: number) => {
        filterStore.set({ empIndexActiveTab: index + 1, scrollTop: 0 }); // 记录回到顶部
        switchTab({ url: '/pages/index/index' });
    };
    const fetchData = () => {
        try {
            Promise.all([fetchWay1(), fetchWay2()]).then(([res1, res2]) => {
                console.log('all', res1, res2);
                const resData1 = res1.data;
                myProjectStatistics[0].num = resData1.state0_count;
                myProjectStatistics[1].num = resData1.state1_count;
                myProjectStatistics[2].num = resData1.state2_count;
                myProjectStatistics[3].num = resData1.state3_count;

                const resData2 = res2.data;
                todoList[0].num = resData2.num_1;
                todoList[1].num = resData2.num_2;
            });
        } catch (error) {
            console.log(error);
        }
    };

    onShow(() => {
        fetchData();
    });
</script>
<style lang="scss" scoped>
    .page-container {
        width: 100vw;
        overflow: hidden;
        background-image: url('../../assets/images/mine-bg.png');
        background-size: cover;
        display: flex;
        flex-direction: column;
        position: relative;
        box-sizing: border-box;
        .mine-cap {
            margin-bottom: 40rpx;
            .cap-title {
                font-weight: 600;
                font-size: 36rpx;
                color: #ffffff;
                line-height: 50rpx;
                margin-top: 24rpx;
                margin-bottom: 40rpx;
                margin-left: 32rpx;
            }
            .cap-set-chunk {
                padding: 62rpx;
                box-sizing: border-box;
                .name {
                    font-weight: 600;
                    font-size: 40rpx;
                    color: #ffffff;
                    line-height: 56rpx;
                    margin-bottom: 24rpx;
                }
                .set-wrap {
                    display: flex;
                    gap: 16rpx;
                    .set-item {
                        padding: 6rpx 20rpx;
                        border-radius: 8rpx;
                        border: 1rpx solid rgba(255, 255, 255, 0.5);
                        font-size: 24rpx;
                        color: #ffffff;
                        line-height: 30rpx;
                    }
                }
            }
        }
        .bottom-wrap {
            flex: 1;
            min-height: 0; /* 允许在 flex 容器里滚动（防止高度被撑死） */
            overflow-y: auto;
            padding: 32rpx;
            box-sizing: border-box;
            .set-item-wrap {
                margin-top: 24rpx;
                .item-title {
                    font-weight: 600;
                    font-size: 32rpx;
                    color: #303133;
                    line-height: 32rpx;
                    margin-bottom: 32rpx;
                }
            }
            .set-item-box {
                display: flex;
                gap: 24rpx;
                flex-wrap: wrap;
                .set-item {
                    width: 48%;
                    min-width: 0;
                    background: #f4f6f8;
                    border-radius: 24rpx;
                    height: 163rpx;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    .set-item-num {
                        font-weight: 600;
                        font-size: 36rpx;
                        color: #303133;
                        line-height: 50rpx;
                    }
                    .set-item-title {
                        font-weight: 400;
                        font-size: 28rpx;
                        color: #909399;
                        line-height: 40rpx;
                    }
                }
            }
        }

        .update-popup {
            .form-item {
                border-radius: 24rpx;
                border: 1rpx solid #e4e4e4;
                padding: 24rpx;
                margin-bottom: 24rpx;
                &:last-of-type {
                    margin-bottom: 48rpx;
                }
                .label {
                    font-weight: 400;
                    font-size: 24rpx;
                    color: #909399;
                    line-height: 24rpx;
                    margin-bottom: 24rpx;
                }
                .uni-input {
                    font-weight: 600;
                    font-size: 28rpx;
                    color: #303133;
                    line-height: 28rpx;
                }
            }
            .btn-wrap {
                display: flex;
                gap: 24rpx;
                .btn {
                    flex: 1;
                    &.cancel {
                        height: 88rpx;
                        background: #e4e4e4;
                        border-radius: 24rpx;
                        font-weight: 600;
                        font-size: 28rpx;
                        color: #ffffff;
                        line-height: 40rpx;
                        text-align: center;
                        line-height: 88rpx;
                        padding: 0;
                        &::after {
                            border: none;
                        }
                    }
                }
            }
        }

        .tips-popup {
            background: #ffffff;
            border-radius: 24rpx;
            overflow: hidden;
            padding: 48rpx 32rpx;
            position: relative;
            width: 80vw;
            // margin: auto;
            .close-popup {
                position: absolute;
                width: 40rpx;
                height: 40rpx;
                background-image: url('@/assets/images/icon-close-pop.png');
                background-size: cover;
                right: 32rpx;
                top: -72rpx;
            }
            .title {
                font-weight: 600;
                font-size: 32rpx;
                color: #303133;
                line-height: 32rpx;
                margin-bottom: 48rpx;
                text-align: center;
            }
            .text {
                font-weight: 400;
                font-size: 28rpx;
                color: #909399;
                text-align: center;
            }
            .btn-box {
                display: flex;
                gap: 24rpx;
                margin-top: 48rpx;
                .btn {
                    flex: 1;
                    min-width: 0;
                    height: 88rpx;
                    background: #f7931e;
                    border-radius: 24rpx;
                    text-align: center;
                    line-height: 88rpx;
                    color: #ffffff;
                    &.cancel {
                        background: #e4e4e4;
                    }
                }
            }
        }
    }
</style>
