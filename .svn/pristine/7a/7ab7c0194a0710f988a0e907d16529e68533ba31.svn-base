import { defineStore } from 'pinia';
import { useFilterStore } from './filter';

type UserInfo = {
    identityId: any;
    identityType: any;
    loginTime: any;
    refreshTime: any;
    source: string;
    sourceType: number;
    userId: any;
    username: string;
};
interface UserState {
    userInfo: UserInfo;
    locale: string;
    token?: string;
    refreshToken?: string;
}

export const useGlobalStore = defineStore('global', {
    state: (): UserState => ({
        userInfo: {} as UserInfo,
        token: '' as string,
        locale: 'zh-Hans',
        refreshToken: '' as string,
    }),
    actions: {
        setUserInfo(info: any) {
            this.userInfo = info;
        },
        setToken(token: string, refreshToken?: string) {
            this.token = token;
            this.refreshToken = refreshToken;
            uni.setStorageSync('token', token);
            uni.setStorageSync('refreshToken', refreshToken);
        },

        setLocale(locale: string) {
            this.locale = locale;
            uni.setStorageSync('locale', locale);
        },
        loginOut() {
            const filterStore = useFilterStore();
            filterStore.clear();
            this.$reset();
            uni.removeStorageSync('token');
            uni.removeStorageSync('refreshToken');

            // 关闭所有页面，跳转到登录页
            uni.reLaunch({
                url: '/pages/login/index',
            });
        },
    },
    /**
     * 类似于组件的computed，用来封装计算属性,有缓存的功能
     */
    getters: {
        getToken(): any {
            return this.token || uni.getStorageSync('token') || '';
        },
    },
    persist: true,
});
