<template>
    <view class="tabbar" :class="{ shadow }" :style="rootStyle">
        <view
            v-for="(it, idx) in tabs"
            :key="it.path || idx"
            class="tab"
            :class="{ active: activePath === it.path }"
            @tap="go(it)"
        >
            <view class="icon-wrap">
                <image class="icon" :src="activePath === it.path ? it.activeIcon : it.icon" mode="widthFix" />
                <!-- <view v-if="it.dot" class="dot"></view>
                <view v-if="it.badge && it.badge > 0" class="badge">{{ it.badge > 99 ? '99+' : it.badge }}</view> -->
            </view>
            <text class="txt">{{ it.text }}</text>
        </view>
    </view>
</template>

<script setup lang="ts">
    import { computed } from 'vue';

    export interface TabItem {
        text: string;
        path: string; // 例如：/pages/index/index
        icon: string; // 未选中图标
        activeIcon: string; // 选中图标
        badge?: number; // 角标数字
        dot?: boolean; // 红点
    }

    const tabs = [
        {
            text: '我的项目',
            path: '/pages/packageCustomer/index/index',
            icon: '/static/tab-pro-normal.png',
            activeIcon: '/static/tab-pro-selected.png',
        },
        {
            text: '我的需求',
            path: '/pages/packageCustomer/requirement/index',
            icon: '/static/tab-requirement-normal.png',
            activeIcon: '/static/tab-requirement-selected.png',
        },
        {
            text: '个人中心',
            path: '/pages/packageCustomer/mine/index',
            icon: '/static/tab-me-normal.png',
            activeIcon: '/static/tab-me-selected.png',
        },
    ];

    const props = withDefaults(
        defineProps<{
            /** 选中态文字颜色 */
            activeColor?: string;
            /** 未选中文字颜色 */
            color?: string;
            /** 背景色 */
            background?: string;
            /** 是否显示顶部阴影边线 */
            shadow?: boolean;
            /** 切换方式：reLaunch 更像原生 tabbar；'navigate' 则保留历史 */
            switchMode?: 'relaunch' | 'navigate';
        }>(),
        {
            activeColor: '#E0AC58',
            color: '#606266',
            background: '#FFFFFF',
            shadow: true,
            switchMode: 'relaunch',
        },
    );

    /** 当前激活路由 */
    const activePath = computed(() => {
        const pages = getCurrentPages();
        const last = pages[pages.length - 1] as any;
        // H5/小程序取到的是 pages 里的相对路径，前面补 '/'
        return last ? '/' + last.route : '';
    });

    /** 根样式（颜色可配） */
    const rootStyle = computed(
        () =>
            ({
                '--active-color': props.activeColor,
                '--color': props.color,
                '--bg': props.background,
            } as any),
    );

    /** 跳转 */
    function go(it: TabItem) {
        if (activePath.value === it.path) return;
        if (props.switchMode === 'navigate') {
            uni.navigateTo({ url: it.path });
        } else {
            // 更接近系统 tabbar 的切换体验，不积压页面栈
            uni.reLaunch({ url: it.path });
        }
    }
</script>

<style scoped lang="scss">
    .tabbar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 102rpx;
        display: flex;
        align-items: center;
        justify-content: space-around;
        background: var(--bg);
        padding-bottom: env(safe-area-inset-bottom);
        z-index: 999;
        &.shadow {
            box-shadow: 0 -6rpx 12rpx rgba(0, 0, 0, 0.02);
            border-top: 1rpx solid #f2f2f2;
        }
    }
    .tab {
        flex: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        .icon-wrap {
            position: relative;
            height: 44rpx;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon {
            width: 44rpx;
            height: 44rpx;
        }
        .txt {
            margin-top: 6rpx;
            font-size: 22rpx;
            color: var(--color);
        }
        &.active .txt {
            color: var(--active-color);
            font-weight: 600;
        }
    }
    .dot {
        position: absolute;
        right: -6rpx;
        top: -2rpx;
        width: 12rpx;
        height: 12rpx;
        background: #ff4d4f;
        border-radius: 50%;
    }
    .badge {
        position: absolute;
        right: -14rpx;
        top: -8rpx;
        min-width: 28rpx;
        height: 28rpx;
        padding: 0 6rpx;
        background: #ff4d4f;
        color: #fff;
        border-radius: 28rpx;
        font-size: 20rpx;
        line-height: 28rpx;
        text-align: center;
    }
</style>
