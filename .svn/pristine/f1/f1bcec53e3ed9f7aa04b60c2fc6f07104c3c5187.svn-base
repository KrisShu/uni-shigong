<!-- 验收选项卡 -->
<template>
    <scroll-view
        class="pd-accept-scroll-area"
        scroll-y
        :show-scrollbar="false"
        :enhanced="true"
        :enable-back-to-top="true"
    >
        <!-- 加载中 -->
        <view v-if="loading && page === 1" class="loading-box">
            <text class="loading-icon">⏳</text>
            <text class="loading-text">{{ $t('common.loading') }}</text>
        </view>

        <!-- 数据为空 -->
        <EmptyBox v-else-if="!loading && acceptanceList.length === 0" />
        <view v-else class="accept-template" v-for="(item, index) in acceptanceList" :key="index">
            <view class="accept-warp">
                <view class="flex j-between a-center">
                    <text class="time">2025-07-09</text>
                    <text class="name">Jey</text>
                </view>

                <view class="status-text">
                    {{ getAcceptStatus(item) }}
                </view>
                <view v-show="item.type != 1" class="status-desc flex">
                    <text class="label">{{ $t('staff.pro.check.key_YSMX') }}：</text>
                    <text class="value">{{ item.reason }}</text>
                </view>

                <ImagePreview :images="item.acceptancePath" />
            </view>
        </view>
    </scroll-view>
</template>

<script lang="ts" setup>
    import { ref } from 'vue';
    import API from '@/apis/index';
    import { i18n } from '@/main';
    import EmptyBox from '@/components/EmptyBox/index.vue';
    import ImagePreview from '@/components/ImagePreview/index.vue';

    const BASEURL = import.meta.env.VITE_IMAGE_BASEURL;

    const props = defineProps<{
        projectId: string | number;
    }>();
    const getAcceptStatus = (item: any) => {
        if (item.type == 1) {
            return i18n.global.t('common.pro.check_state_TJYS');
        } else if (item.type == 2) {
            if (item.choose == 1) {
                return i18n.global.t('common.pro.check_state_JY');
            } else if (item.choose == 2) {
                return i18n.global.t('common.pro.check_state_JN');
            }
        } else if (item == 3) {
            if (item.choose == 1) {
                return i18n.global.t('common.pro.check_state_YY');
            } else if (item.choose == 2) {
                return i18n.global.t('common.pro.check_state_YN');
            }
        }
    };

    const acceptanceList = ref<any>([]);
    const page = ref(1);
    const loadingText = ref('');

    const loading = ref(false); //
    const hasMore = ref(true); // 新增：是否还有更多数据
    const getAcceptanceList = async () => {
        if (loading.value) return; // ✅ 防止重复加载
        loading.value = true;
        loadingText.value = i18n.global.t('common.loading');
        try {
            const res = await API.CUS_ProjectAcceptanceList({
                id: props.projectId,
            });
            const newData = res.data.list || [];

            newData.forEach((item: any) => {
                item.acceptancePath = item.acceptancePath
                    ? item.acceptancePath.split(',').map((img: any) => BASEURL + img)
                    : '';
            });

            if (newData.length < res.data.pageSize) {
                console.log('没有更多数据了');
                hasMore.value = false;
                loadingText.value = i18n.global.t('common.no-more');
            } else {
                console.log('上拉加载更多');
                hasMore.value = true;
                loadingText.value = i18n.global.t('common.release');
            }
            acceptanceList.value.push(...newData);

            console.log('列表结果res', res);
        } catch (error) {
            console.log('列表结果error', error);
        } finally {
            loading.value = false;
        }
    };

    getAcceptanceList();
</script>

<style lang="scss" scoped>
    .pd-accept-scroll-area {
        height: 100%;
        overflow: auto;
        box-sizing: border-box;
        .accept-template {
            position: relative;
            padding-left: 42rpx;
            &::before {
                content: '';
                display: block;
                width: 32rpx;
                height: 32rpx;
                border-radius: 50%;
                background-color: #fff;
                border: 8rpx solid #303133;
                position: absolute;
                left: 0;
                top: 0;
                box-sizing: border-box;
            }
            &::after {
                content: '';
                display: block;
                height: 80%;
                width: 1rpx;
                background-color: #909399;
                position: absolute;
                left: 15rpx;
                top: 42rpx;
            }
            &:last-of-type {
                &::after {
                    background-color: transparent;
                }
            }
            & ~ .accept-template {
                margin-top: 24rpx;
            }
        }
        .accept-warp {
            background: #ffffff;
            border-radius: 24rpx;
            padding: 24rpx;

            .time {
                font-weight: 600;
                font-size: 28rpx;
                color: #303133;
                line-height: 28rpx;
            }
            .name {
                font-weight: 400;
                font-size: 24rpx;
                color: #909399;
            }
            .status-text {
                font-weight: 400;
                font-size: 28rpx;
                color: #909399;
                line-height: 28rpx;
                margin-bottom: 24rpx;
                margin-top: 24rpx;
            }
            .status-desc {
                font-weight: 400;
                font-size: 28rpx;
                color: #909399;
                margin-bottom: 24rpx;
                .label {
                    flex-shrink: 0;
                }
            }
        }
    }
</style>
