<template>
    <view class="wrap-01">
        <view class="pd-card__title">{{ info.name }}</view>
        <view class="pd-card__address">{{ info.address }}</view>
        <!-- 项目卡片 -->
        <view class="pd-card">
            <!-- 使用车辆 -->
            <view class="pd-field">
                <view class="pd-field__label">{{ $t('common.pro.key_car') }}：</view>
                <view class="pd-field__chips">
                    <view class="pd-chip">{{ info.hardwareNames }}</view>
                </view>
            </view>
            <!-- 参与人 -->
            <view class="pd-field">
                <view class="pd-field__label">{{ $t('staff.pro.key_person') }}：</view>

                <view class="pd-field__chips people-list flex">
                    <!-- 人员列表的第一个为项目发起人 -->
                    <view v-for="(people, p) in workerNameArr" class="people-item" :class="p === 0 ? 'leader' : ''">
                        {{ people }}
                    </view>
                </view>
            </view>

            <!-- 预计工期 -->
            <view class="pd-field">
                <view class="pd-field__label">{{ $t('common.pro.key_date') }}：</view>
                <view class="pd-field__value">{{ info.period }}{{ $t('common.unit.day') }}</view>
            </view>

            <!-- 项目勘察图 -->
            <view class="pd-field">
                <view class="pd-field__label">{{ $t('common.pro.key_image') }}：</view>
                <ImagePreview :images="images" />
            </view>
        </view>
        <!-- 安全注意事项 -->
        <view class="pd-card2">
            <view class="pd-card__title">{{ $t('common.pro.key_tip') }}</view>

            <view class="pd-list">
                <view class="pd-list__item">
                    {{ info.security }}
                </view>
            </view>
        </view>

        <!-- 确认启动项目 -->
        <view @click="sureNext" class="progress-btn">
            {{ $t('staff.pro.start_step_1_btn') }}
        </view>
    </view>
</template>

<script lang="ts" setup>
    import API from '@/apis/index';
    import ImagePreview from '@/components/ImagePreview/index.vue';
    import { reactive, defineEmits, defineProps, watch, toRef, computed, ref } from 'vue';
    interface ProjectInfo {
        name?: string;
        address?: string;
        hardwareNames?: string;
        workerNames?: string;
        period?: number | string;
        locationPath?: string;
        security?: string;
    }

    const props = withDefaults(
        defineProps<{
            projectRecord?: { info?: ProjectInfo };
            projectId: string | number;
        }>(),
        {
            // ✅ 默认值避免 undefined 链
            projectRecord: () => ({ info: {} }),
        },
    );

    const BASEURL = import.meta.env.VITE_IMAGE_BASEURL;

    const info = computed(() => props.projectRecord!.info || {});

    const images = computed(() => {
        const str = info.value.locationPath || '';
        return str ? str.split(',').map(s => (s.startsWith('http') ? s : BASEURL + s)) : [];
    });

    const workerNameArr = computed(() => {
        const s = info.value.workerNames || '';
        return s ? s.split(',') : [];
    });

    const emits = defineEmits<{ (e: 'next'): void }>();
    const sureNext = async () => {
        await API.EMP_ProjectSafeguardRead({ id: props.projectId });
        emits('next');
    };
</script>

<style lang="scss">
    .wrap-01 {
        height: 100%;
        padding-bottom: 150rpx;
        position: relative;
        box-sizing: border-box;
        .pd-card__title {
            font-weight: 600;
            font-size: 32rpx;
            color: #303133;
            line-height: 32rpx;
            margin-bottom: 20rpx;
        }
        .pd-card__address {
            font-weight: 400;
            font-size: 28rpx;
            color: #909399;
            line-height: 36rpx;
            display: flex;
            align-items: center;
            margin-bottom: 24rpx;
            position: relative;
            padding-left: 40rpx;
            &::before {
                content: '';
                display: inline-block;
                width: 30rpx;
                height: 36rpx;
                background-image: url('../../../../assets/images/location.png');
                background-size: 100% 100%;
                position: absolute;
                left: 0;
            }
        }
        .pd-card {
            background: #f4f6f8;
            border-radius: 24rpx;
            padding: 24rpx;
            .pd-field {
                display: flex;
                font-weight: 400;
                font-size: 28rpx;
                color: #909399;
                line-height: 32rpx;
                & ~ .pd-field {
                    margin-top: 24rpx;
                }
                .pd-field__label {
                    flex-shrink: 0;
                }
                .pd-field__chips {
                    display: flex;
                    flex-wrap: wrap;
                    .pd-chip {
                        // flex-shrink: 0;
                    }
                    &.people-list {
                        gap: 8rpx;
                        flex-wrap: wrap;
                        .people-item {
                            height: 40rpx;
                            line-height: 40rpx;
                            padding: 0 8rpx;
                            background: #ffffff;
                            border-radius: 8rpx;
                            font-size: 24rpx;
                            &.leader {
                                position: relative;
                                padding-left: 38rpx;
                                &::before {
                                    content: '';
                                    display: inline-block;
                                    width: 24rpx;
                                    height: 22rpx;
                                    background: url('../../../../assets/images/leader.png');
                                    background-size: cover;
                                    position: absolute;
                                    left: 8rpx;
                                    top: 50%;
                                    transform: translateY(-50%);
                                }
                            }
                        }
                    }
                }
                .pd-images {
                    display: flex;
                    gap: 16rpx;
                    flex-wrap: wrap;
                    .pd-image-box {
                        width: 154rpx;
                        height: 154rpx;
                        border-radius: 8rpx;
                        background-color: saddlebrown;
                        position: relative;
                        &::before {
                            content: '';
                            display: block;
                            width: 24rpx;
                            height: 24rpx;
                            position: absolute;
                            top: 6rpx;
                            right: 6rpx;
                            background-image: url('../../../../assets/images/view.png');
                            background-size: 100% 100%;
                        }
                    }
                    .pd-image {
                        width: 100%;
                        height: 100%;
                    }
                }
            }
        }
        .pd-card2 {
            margin-top: 32rpx;
            .pd-card__title {
                font-weight: 600;
                font-size: 28rpx;
                color: #303133;
                line-height: 40rpx;
                display: flex;
                align-items: center;
                &::before {
                    content: '';
                    display: inline-block;
                    width: 30rpx;
                    height: 30rpx;
                    background-image: url('../../../../assets/images/iconfont-warning.png');
                    background-size: cover;
                    margin-right: 10rpx;
                }
            }
            .pd-list {
                font-weight: 400;
                font-size: 24rpx;
                color: #909399;
                line-height: 24rpx;
                .pd-list__item {
                    white-space: pre-line; /* 或 pre-wrap 都可以 */
                }
            }
        }

        .progress-btn {
            width: 100%;
            background: #f7931e;
            border-radius: 24rpx;
            height: 88rpx;
            line-height: 88rpx;
            text-align: center;
            font-weight: 600;
            font-size: 28rpx;
            color: #ffffff;
            position: absolute;
            bottom: 32rpx;
        }
    }
</style>
