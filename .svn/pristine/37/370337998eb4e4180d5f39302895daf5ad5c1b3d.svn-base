<template>
    <view class="wrap-02">
        <view class="title">{{ $t('staff.pro.start_step_2_title') }}</view>

        <view class="questionList-wrap">
            <view class="question-item" v-for="(item, index) in questionList" :key="item.problemId || index">
                <view class="question-title">{{ index + 1 }}、{{ item.title }}</view>

                <view class="question-answer">
                    <view class="answer-item">
                        <!-- 每道题一个 radio-group，change 时把该题的 result 写回去 -->
                        <radio-group class="radio-group" @change="(e:any) => onGroupChange(e, item)">
                            <label v-for="opt in item.answerOptions" :key="opt.value" class="radio-label">
                                <radio
                                    style="transform: scale(0.6)"
                                    activeBackgroundColor="#303133"
                                    :value="String(opt.value)"
                                    :checked="String(item.result) === String(opt.value)"
                                />
                                <view class="value-text">{{ opt.name }}</view>
                            </label>
                        </radio-group>
                    </view>

                    <!-- 选“有问题”才显示说明 -->
                    <view class="answer-desc" v-show="String(item.result) === '2'">
                        <textarea
                            v-model="item.detail"
                            class="textarea"
                            placeholder-class="ph"
                            :placeholder="$t('staff.pro.start_step_2_placeholder')"
                        />
                    </view>
                </view>
            </view>
        </view>

        <LockButton :onClick="nextThree"> {{ $t('staff.pro.start_step_2_btn') }}</LockButton>
    </view>
</template>

<script lang="ts" setup>
    import { reactive } from 'vue';
    import API from '@/apis/index';
    import { i18n } from '@/main';
    import LockButton from '@/components/LockButton/index.vue';

    interface AnswerOption {
        name: string;
        value: string | number;
    }
    interface QuestionItem {
        problemId: number | string;
        title: string;
        answerOptions: AnswerOption[];
        result?: string | number; // 建议统一成 string
        detail?: string;
    }

    const props = withDefaults(
        defineProps<{
            projectRecord?: { type: number; info: QuestionItem[] };
            projectId: string | number;
        }>(),
        { projectRecord: () => ({ type: 0, info: [] }) },
    );

    /** ⚠️ 不要直接改 props，做一份本地可编辑副本 */
    const questionList = reactive<QuestionItem[]>(
        // (props.projectRecord?.info ?? []).map(q => ({
        //     ...q,
        //     result: q.result != null ? String(q.result) : '', // 统一字符串
        //     detail: q.detail ?? '',
        // })),
        [
            {
                problemId: 1,
                title: '设备是否正常',
                answerOptions: [
                    { name: '正常', value: 1 },
                    { name: '有问题', value: 2 },
                ],
                result: 1,
                detail: '11',
            },
            {
                problemId: 2,
                title: '设备是否正常',
                answerOptions: [
                    { name: '正常', value: 1 },
                    { name: '有问题', value: 2 },
                ],
                result: 2,
                detail: '22',
            },
        ],
    );

    /** 选项切换：把该题的 result 写回去（字符串） */
    const onGroupChange = (e: any, q: QuestionItem) => {
        q.result = String(e.detail.value);
        if (q.result !== '2') q.detail = ''; // 切回“正常”时清空备注（按需）
    };

    /** 提交 */
    const emits = defineEmits<{ (e: 'next'): void }>();
    const nextThree = async () => {
        // 在这里可以拿到 questionList 里每题的 result/detail
        // console.log(JSON.stringify(questionList))
        try {
            const res = await API.EMP_ProjectEquipmentCheck({
                id: props.projectId,
                sgProCheckList: questionList,
            });
            uni.showToast({ title: i18n.global.t('common.status.success'), icon: 'success' });
            setTimeout(() => {
                emits('next');
            }, 1000);
        } catch (error) {
            console.log('error', error);
        }
    };
</script>

<style lang="scss" scoped>
    .wrap-02 {
        height: 100%;
        .title {
            font-weight: 600;
            font-size: 32rpx;
            color: #303133;
            line-height: 32rpx;
            margin-bottom: 32rpx;
        }
        .questionList-wrap {
            height: 88%;
            overflow-y: auto;
        }
        .question-item {
            margin-bottom: 48rpx;
            .question-title {
                font-weight: 400;
                font-size: 28rpx;
                color: #303133;
                margin-bottom: 22rpx;
            }

            .radio-group {
                display: flex;
                .uni-label-pointer {
                    display: flex;
                    margin-right: 200rpx;
                }
                .value-text {
                    font-size: 28rpx;
                    color: #909399;
                    padding-top: 4rpx;
                }
            }
            .answer-desc {
                height: 120rpx;
                background: #f4f6f8;
                border-radius: 24rpx;
                font-size: 28rpx;
                padding: 24rpx;
                margin-top: 24rpx;
                .textarea {
                    height: 100%;
                }
            }
        }

        .progress-btn {
            width: 90%;
            background: #f7931e;
            border-radius: 24rpx;
            height: 88rpx;
            line-height: 88rpx;
            text-align: center;
            font-weight: 600;
            font-size: 28rpx;
            color: #ffffff;
            position: absolute;
            bottom: 32rpx;
        }
    }
</style>
