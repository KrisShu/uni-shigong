// src/utils/photo.ts
/**
 * 拍照（仅相机）
 *
 * @param opts.compressed 是否压缩
 * @param opts.timeoutMs 可选：超时兜底，默认 12s
 * @returns Promise<{ path: string; size: number; mime?: string } | null>

 */

export interface PhotoFile {
    path: string; // 本地临时路径
    size: number; // 字节
    mime?: string; // 可能为空（部分端没有）
    ext: string; // 扩展名（小写）
}

/** 获取扩展名（不含 .） */
export function getExtByPath(p: string): string {
    return (p?.split('?')[0].match(/\.([a-zA-Z0-9]+)$/)?.[1] || '').toLowerCase();
}

/** 拍照（仅相机），成功返回一张图片文件信息；用户取消返回 'CANCEL' */
export function takePhoto(opts?: {
    compressed?: boolean;
    timeoutMs?: number; // 可选：超时兜底，默认 12s
}): Promise<{ path: string; size: number; mime?: string } | null> {
    const { compressed = true, timeoutMs = 30000 } = opts || {};

    return new Promise(resolve => {
        let settled = false;
        const finish = (val: any) => {
            if (settled) return;
            settled = true;
            clearTimeout(timer);
            resolve(val);
        };

        // 超时兜底：某些浏览器取消时既不 success 也不 fail
        const timer = setTimeout(() => {
            console.warn('[takePhoto] chooseImage timeout, resolve(null)');
            finish(null);
        }, timeoutMs);

        uni.chooseImage({
            count: 1,
            sizeType: [compressed ? 'compressed' : 'original'],
            sourceType: ['camera'],

            success: res => {
                console.log('[takePhoto] success =>', res);
                // 部分内核会 success 但没文件
                const files: any[] = Array.isArray(res.tempFiles)
                    ? res.tempFiles
                    : res.tempFiles
                    ? [res.tempFiles]
                    : [];
                const f: any = files[0];
                if (!f) return finish(null);

                const path = f.path || f.tempFilePath || (res.tempFilePaths && res.tempFilePaths[0]) || '';
                if (!path) return finish(null);

                const size = f.size ?? 0;
                const mime = f.type;
                finish({ path, size, mime });
            },

            fail: err => {
                console.log('[takePhoto] fail =>', err);
                // 统一按取消处理
                finish(null);
            },

            complete: () => {
                console.log('[takePhoto] complete');
                // 某些端不会进 success/fail，也要收口
                // 注意：如果 success 已经 finish，这里会被 finish 的“一次性锁”拦住
                finish(null);
            },
        });
    });
}

/** 校验图片（类型 + 大小），不通过抛错；通过则无返回 */
export function validateImage(
    file: Pick<PhotoFile, 'ext' | 'mime' | 'size'>,
    options?: { acceptExt?: string[]; maxMB?: number },
): void {
    const accept = (options?.acceptExt || ['png', 'jpg', 'jpeg', 'webp', 'gif', 'bmp']).map(s => s.toLowerCase());
    const maxBytes = (options?.maxMB ?? 5) * 1024 * 1024;

    const isTypeOk = (file.mime && file.mime.startsWith('image/')) || (file.ext && accept.includes(file.ext));
    if (!isTypeOk) {
        throw new Error(`仅支持图片类型：${accept.join('/')}`);
    }
    if (file.size > maxBytes) {
        throw new Error(`图片不能超过 ${options?.maxMB ?? 5}MB`);
    }
}
