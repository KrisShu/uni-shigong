import { useGlobalStore } from '@/stores';
import { refreshTokenWay } from '@/utils/request';

/**
 * 上传单张文件，返回服务器上的 URL有token过期刷新逻辑
 * @param localPath 本地临时路径
 * @param options   { uploadUrl,  formData}
 */
export function uploadOne(
    localPath: string,
    options: {
        uploadUrl: string;
        formData?: Record<string, any>;
    },
): Promise<any> {
    const store = useGlobalStore();
    const IMAGE_BASE = import.meta.env.VITE_IMAGE_BASEURL || '';

    const { uploadUrl, formData } = options || {};

    const doUpload = (token: string) =>
        new Promise<any>((resolve, reject) => {
            uni.uploadFile({
                url: uploadUrl,
                filePath: localPath,
                name: 'file',
                formData,
                header: {
                    Accept: 'application/json',
                    token: token || '',
                },
                success: res => {
                    if (res.statusCode !== 200) return reject(`HTTP ${res.statusCode}`);
                    try {
                        const data = typeof res.data === 'string' ? JSON.parse(res.data) : res.data;
                        resolve(data);
                    } catch (e) {
                        reject('返回解析失败');
                    }
                },
                fail: err => reject(err?.errMsg || '上传失败'),
            });
        });

    return new Promise(async (resolve, reject) => {
        try {
            const currentToken = uni.getStorageSync('token') || store?.token || '';
            let data: any = await doUpload(currentToken);

            // 成功
            if (data?.code === 2000) {
                const raw1 = data.data.filePath;
                const finalUrl = String(raw1 || '').startsWith('http') ? raw1 : IMAGE_BASE + raw1;
                if (!finalUrl) return reject('上传成功但未返回地址');
                return resolve({ path: raw1, url: finalUrl });
            }

            // token 过期 -> 调用共享刷新逻辑并重试一次
            if (data?.code === 1010) {
                console.log('============刷新 token=========');
                try {
                    const refreshToken = uni.getStorageSync('refreshToken') || '';
                    const newToken = await refreshTokenWay(refreshToken);
                    // 重试上传
                    data = await doUpload(newToken);
                    if (data?.code === 2000) {
                        const raw2 = data.data.filePath;
                        const finalUrl = String(raw2 || '').startsWith('http') ? raw2 : IMAGE_BASE + raw2;
                        if (!finalUrl) return reject('上传成功但未返回地址');
                        return resolve({ path: raw2, url: finalUrl });
                    } else {
                        return reject(data?.msg || '上传失败');
                    }
                } catch (err: any) {
                    console.error('上传图片组件的上传失败===', err);
                    store.loginOut();
                    return reject(err?.message || String(err) || '刷新 token 失败');
                }
            }

            if (data?.code === 1003 || data?.code === 1009) {
                console.log('============账号信息过期 请重新登录=========');
                store.loginOut();

                return reject('账号信息过期 请重新登录');
            }

            // 其它错误
            reject(data?.msg || '上传失败');
        } catch (err: any) {
            reject(err?.message || String(err) || '上传失败');
        }
    });
}
