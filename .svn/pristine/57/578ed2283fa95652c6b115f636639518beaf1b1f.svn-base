<template>
    <view class="pp-wrap">
        <!-- 右上角状态角标（如：延期） -->
        <view v-if="systemProgress > workerProgress" class="pp-badge">{{ $t('staff.pro.delay') }}</view>

        <view class="progress-bar" :style="{ width: barWidth }">
            <!-- 底层进度条（进度较快的） -->
            <view
                class="bar"
                :style="{
                    width: animatedFastProgress + '%',
                    background: fastColor,
                    zIndex: 1,
                }"
            >
            </view>
            <!-- 顶层进度条（进度较慢的） -->
            <view
                v-if="systemProgress > workerProgress"
                class="bar"
                :style="{
                    width: animatedSlowProgress + '%',
                    background: slowColor,
                    zIndex: 2,
                    position: 'absolute',
                    top: 0,
                    left: 0,
                }"
            >
            </view>
        </view>
        <!-- 实际进度小于计划进度 气泡 -->
        <view
            v-show="workerProgress < systemProgress"
            class="pp-pill slow-fill"
            :style="{ background: slowColor, left: slowLeftPercent + '%' }"
        >
            <view class="slow-pan"> {{ slowProgress }}%</view>
            <view class="fast-pan"> {{ fastProgress }}%</view>
        </view>
        <!-- 实际进度大于等于计划进度 气泡 -->
        <view
            v-show="workerProgress && workerProgress >= systemProgress"
            class="pp-pill fast-fill"
            :style="{
                left: fastLeftPercent + '%',
                background: fastColor,
            }"
        >
            {{ fastProgress }}%
        </view>
        <!-- 图例 -->
        <view class="pp-legend">
            <view class="pp-legend__item" v-show="showLegend">
                <view class="pp-dot pp-dot--actual"></view>
                <!-- <text>实际施工进度</text> -->
                <text>{{ $t('staff.pro.actual_progress') }}</text>
            </view>
            <view class="pp-legend__item" v-show="showLegend">
                <view class="pp-dot pp-dot--plan"></view>
                <!-- <text>计划施工进度</text> -->
                <text>{{ $t('staff.pro.plan_progress') }}</text>
            </view>
        </view>
    </view>
</template>

<script setup lang="ts">
    import { computed, ref, watch, onMounted } from 'vue';
    // import sysfillbg from '@/assets/images/sys-fill-bg.png';
    // import workerfillbg from '@/assets/images/worker-fill-bg.png';

    const props = defineProps<{
        systemProgress: number; // 0-100
        workerProgress: number; // 0-100
        barWidth?: string;
        showLegend?: boolean;
    }>();

    const barWidth = props.barWidth || '100%';

    const fastProgress = computed(() => Math.max(props.systemProgress, props.workerProgress));
    const slowProgress = computed(() => Math.min(props.systemProgress, props.workerProgress));
    const systemColor = '#F5CEA0'; //计划施工进度颜色
    const workerColor = '#F7931E'; // 实际施工进度颜色

    const fastColor = computed(() => (props.systemProgress > props.workerProgress ? systemColor : workerColor)); // 蓝色或绿色
    const slowColor = computed(() => (props.systemProgress <= props.workerProgress ? systemColor : workerColor));

    const MIN_MARKER = 8;
    const MAX_MARKER = 92;
    const clampMarker = (v: number) => Math.min(MAX_MARKER, Math.max(MIN_MARKER, v));

    // 动画进度
    const animatedFastProgress = ref(0);
    const animatedSlowProgress = ref(0);

    const animateProgress = (target: number, animated: typeof animatedFastProgress) => {
        animated.value = 0;
        const step = () => {
            if (animated.value < target) {
                animated.value += Math.max(1, Math.floor(target / 30));
                if (animated.value > target) animated.value = target;
                setTimeout(step, 16);
            }
        };
        step();
    };
    const fastLeftPercent = computed(() => clampMarker(animatedFastProgress.value) - 10);
    const slowLeftPercent = computed(() => clampMarker(animatedSlowProgress.value) - 10);

    onMounted(() => {
        animateProgress(fastProgress.value, animatedFastProgress);
        setTimeout(() => {
            animateProgress(slowProgress.value, animatedSlowProgress);
        }, 200); // 慢的稍后一点出现更有层次感
    });

    // 监听props变化时重新动画
    watch([fastProgress, slowProgress], ([newFast, newSlow]) => {
        animateProgress(newFast, animatedFastProgress);
        setTimeout(() => {
            animateProgress(newSlow, animatedSlowProgress);
        }, 200);
    });
</script>

<style scoped lang="scss">
    .progress-bar {
        position: relative;
        height: 24rpx;
        background: #e5e7eb;
        border-radius: 12rpx;
        margin: 16rpx 0;
        // overflow: hidden;
    }
    .bar {
        height: 100%;
        border-radius: 12rpx;
        transition: width 0.3s;
        position: relative;
    }
    /* 容器：你页面的橙色卡片由外层决定，这里只做进度区域 */
    .pp-wrap {
        position: relative;
        padding-top: 20rpx;
        // background-color: saddlebrown;
        // padding-bottom: 20rpx;
    }

    /* 角标（右上） */
    .pp-badge {
        position: absolute;
        right: 10rpx;
        top: -10rpx; /* 胶囊在轨道之上（按UI） */
        font-size: 22rpx;
        line-height: 1;
        background-image: url('../../assets/images/delay-bg.png');
        background-size: 100% 100%;
        min-width: 56rpx;
        padding: 0 10rpx;
        height: 38rpx;
        line-height: 38rpx;
        color: #fff;
        text-align: center;
        font-weight: 400;
        font-size: 20rpx;
        color: #ffffff;
    }

    .pp-bars {
        margin-top: 12rpx;
    }

    /* 百分比胶囊 */
    .pp-pill {
        color: #fff;
        font-size: 20rpx;

        &.fast-fill {
            bottom: 34rpx; /* 胶囊在轨道之上（按UI） */
            border-radius: 16rpx;
            position: absolute;
            padding: 0 8rpx;
            line-height: 32rpx;
            height: 32rpx;

            width: fit-content;
            text-align: center;
            &::before {
                content: '';
                position: absolute;
                right: 40%;
                top: -6rpx;
                width: 0;
                height: 0;
                border-left: 8rpx solid transparent;
                border-right: 8rpx solid transparent;
                border-bottom: 8rpx solid #f7931e; /* 方向=上（指向下方） */
                z-index: 1;
            }
        }
        &.slow-fill {
            bottom: 34rpx;
            // border-radius: 0rpx 10rpx 10rpx 10rpx;
            height: 32rpx;
            background: #f7931e;
            line-height: 32rpx;
            padding-left: 8rpx;
            position: absolute;
            border-radius: 16rpx;
            display: flex;
            align-items: center;
            &::before {
                content: '';
                position: absolute;
                right: 40%;
                top: -8rpx;
                width: 0;
                height: 0;
                border-left: 8rpx solid transparent;
                border-right: 8rpx solid transparent;
                border-bottom: 8rpx solid #f7931e; /* 方向=上（指向下方） */
                z-index: 1;
            }
            .slow-pan {
                padding-right: 8rpx;
            }
            .fast-pan {
                height: 30rpx;
                line-height: 30rpx;
                padding: 0 8rpx;
                background: #f5cea0;
                border-radius: 16rpx;
            }
        }
    }

    .pp-pill--actual {
        background: #f59e0b;
        color: #fff;
        border-color: #fff;
    }
    .pp-pill--plan {
        background: #e5e7eb;
        color: #555;
    }

    /* 图例 */
    .pp-legend {
        display: flex;
        gap: 100rpx;
        align-items: center;
        margin-top: 60rpx;
        height: 26rpx;
        .pp-legend__item {
            display: flex;
            align-items: center;
            gap: 12rpx;

            font-weight: 400;
            font-size: 20rpx;
            color: #909399;
        }
        .pp-dot {
            width: 20rpx;
            height: 20rpx;
            border-radius: 4rpx;
        }
        .pp-dot--actual {
            background: #f7931e;
        }
        .pp-dot--plan {
            background: #f5cea0;
        }
    }
</style>
