<template>
    <view class="page invoice-page">
        <view class="pd-header common-cap">
            <!-- 示例：返回按钮 -->
            <view class="pd-back common-back" @click="Back"> </view>
            <text class="pd-title common-title">{{ $t('cus.invoice.title') }}</text>
        </view>

        <scroll-view
            class="scroll-content"
            :scroll-y="true"
            :refresher-enabled="true"
            :refresher-triggered="refreshing"
            @refresherrefresh="onRefresh"
            @scrolltolower="onLoadMore"
            refresher-background="transparent"
        >
            <!-- 加载中 -->
            <view v-if="loading && page === 1" class="loading-box">
                <text class="loading-icon">⏳</text>
                <text class="loading-text">{{ $t('common.loading') }}</text>
            </view>

            <!-- 数据为空 -->
            <EmptyBox v-else-if="!loading && invoiceList.length === 0" />

            <view v-else>
                <view class="invoice-card" v-for="(invoice, index) in invoiceList" :key="index">
                    <!-- 开票时间 -->
                    <view class="info-row">
                        <text class="label">开票时间</text>
                        <text class="value">{{ invoice.creattime }}</text>
                    </view>
                    <!-- 开票金额 -->
                    <view class="info-row">
                        <text class="label">开票金额</text>
                        <text class="value">{{ invoice.amount }}</text>
                    </view>

                    <!-- 分割线 -->
                    <view class="divider"></view>

                    <!-- 下载发票按钮 -->
                    <view class="download-btn" @click="downloadInvoice(invoice.filePath)">
                        <text class="btn-text">下载发票</text>
                    </view>
                </view>
            </view>
        </scroll-view>
    </view>
</template>

<script setup lang="ts">
    import { ref, reactive } from 'vue';
    import EmptyBox from '@/components/EmptyBox/index.vue';
    import API from '@/apis/index';
    import { i18n } from '@/main';
    import { useSmartBack } from '@/hooks/useSmartBack';
    import { onLoad } from '@dcloudio/uni-app';
    const { smartBack } = useSmartBack();

    const invoiceList = ref<any[]>([]);
    const currentProjectId = ref<any>(0);
    const page = ref(1);
    const loadingText = ref('');
    const refreshing = ref(false);
    const loading = ref(false); //
    const hasMore = ref(true); // 新增：是否还有更多数据

    const fetchData = async (reset = false) => {
        if (loading.value) return; // ✅ 防止重复加载
        loading.value = true;
        loadingText.value = i18n.global.t('common.loading');

        if (reset) {
            page.value = 1;
            invoiceList.value = [];
            hasMore.value = true; // 重置时认为还有更多，直到服务端返回判断
        }

        try {
            const res = await API.CUS_ProjectInvoiceList({
                id: currentProjectId.value,
                pageNo: page.value, //page.value
            });
            const newData = res.data.list || [];

            if (newData.length < res.data.pageSize) {
                console.log('没有更多数据了');
                hasMore.value = false;
                loadingText.value = i18n.global.t('common.no-more');
            } else {
                console.log('上拉加载更多');
                hasMore.value = true;
                loadingText.value = i18n.global.t('common.release');
            }
            if (reset) {
                invoiceList.value = newData;
            } else {
                invoiceList.value.push(...newData);
            }

            console.log('列表结果res', res);
        } catch (error) {
            console.log('列表结果error', error);
        } finally {
            refreshing.value = false;
            loading.value = false;
        }
    };

    const onRefresh = () => {};
    const onLoadMore = () => {};

    const Back = () => {
        let fallback = '/pages/packageCustomer/index/proDetail/index';
        smartBack(fallback);
    };
    const BASEURL = import.meta.env.VITE_IMAGE_BASEURL;

    function downloadForH5(blobUrl: any, originalUrl: any) {
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = blobUrl;

        // 尝试从 URL 提取文件名
        const fileName = decodeURIComponent(originalUrl.split('/').pop()) || 'download';

        a.download = fileName; // 指定下载的文件名
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // 可选：释放 Blob URL 内存
        setTimeout(() => {
            URL.revokeObjectURL(blobUrl);
        }, 100);

        uni.showToast({ title: '开始下载' });
    }
    function downloadInvoice(path: string) {
        // 模拟下载发票
        // uni.showToast({
        //     title: '发票已下载',
        //     icon: 'success',
        // });
        console.log('uni.getSystemInfoSync().platform', uni.getSystemInfoSync().platform);

        uni.downloadFile({
            url: BASEURL + path, //仅为示例，并非真实的资源
            success: res => {
                console.log('下载结果res', res);
                if (res.statusCode === 200) {
                    const tempFilePath = res.tempFilePath;

                    //ifdef H5
                    // H5 平台：创建 a 标签模拟点击下载
                    downloadForH5(tempFilePath, path);
                    //endif

                    //ifdef APP-PLUS
                    uni.saveFile({
                        tempFilePath,
                        success: () => {
                            uni.showToast({ title: '已保存' });
                        },
                        fail: () => {
                            uni.showToast({ title: '保存失败', icon: 'none' });
                        },
                    });
                    //endif
                }
            },
        });
    }

    onLoad((options: any) => {
        currentProjectId.value = options.id;
        fetchData(true);
    });
</script>
<style lang="scss" scoped>
    .invoice-page {
        display: flex;
        flex-direction: column;
        height: 100vh; /* 让页面占满可视高度 */
        overflow: hidden; /* 避免外层也滚动 */
    }

    .nav-back {
        position: absolute;
        left: 30rpx;
        top: 40rpx;
        z-index: 99;
        font-size: 40rpx;
        color: #333;
    }

    .page-title {
        margin-top: 40rpx;
        font-size: 40rpx;
        font-weight: bold;
        color: #333;
    }

    .invoice-card {
        background-color: white;
        border-radius: 24rpx;
        padding: 24rpx;
        margin-bottom: 24rpx;
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 28rpx;
            color: #909399;
            margin-bottom: 24rpx;
            .label {
                color: #909399;
            }
            .value {
                color: #303133;
            }
        }
        .divider {
            width: 100%;
            height: 1rpx;
            border-top: 1rpx dashed #e4e4e4;
            margin-top: 40rpx;

            display: block;
            position: relative;
            &::before,
            &::after {
                content: '';
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                width: 36rpx;
                height: 36rpx;
                border-radius: 50%;
                background-color: #f4f6f8;
            }
            &::before {
                left: -40rpx;
            }
            &::after {
                right: -40rpx;
            }
        }
    }

    .download-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24rpx;
        color: #303133;
        margin-top: 20rpx;
        cursor: pointer;
        .btn-text {
            position: relative;
            padding-left: 45rpx;
            &::before {
                content: '';
                background-image: url('@/assets/images/download.png');
                background-size: cover;
                display: block;
                width: 35rpx;
                height: 37rpx;
                position: absolute;
                left: 0;
            }
        }
    }
</style>
