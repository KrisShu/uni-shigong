<!-- 打卡tab页 -->
<template>
    <view class="pd-punch">
        <!-- 历史打卡记录 -->
        <view class="pd-punch-history">
            <view class="cap-title">{{ $t('common.pro.clock_in.key_history') }}</view>
            <scroll-view
                class="history-wrap"
                scroll-y
                :show-scrollbar="false"
                :enhanced="true"
                :enable-back-to-top="true"
                @scrolltolower="onLoadMore"
            >
                <!-- 加载中 -->
                <view v-if="loading && page === 1" class="loading-box">
                    <text class="loading-icon">⏳</text>
                    <text class="loading-text">{{ $t('common.loading') }}</text>
                </view>

                <!-- 数据为空 -->

                <EmptyBox v-else-if="!loading && historyList.length === 0" />
                <view v-else class="pd-punch-history__item" v-for="(item, index) in historyList" :key="index">
                    <view class="flex j-between a-center">
                        <view class="pd-punch-history__time">{{ item.clockDate }}</view>
                        <view class="pd-punch-history__people">
                            {{ $t('common.pro.clock_in.key_DKR') }}：{{ item.workerName }}
                        </view>
                    </view>
                    <view class="flex j-between punch-images">
                        <view class="punch-image" v-for="(his, i) in item.workerRecordsList" :key="i">
                            <text class="label" v-show="his.imgPath">
                                {{
                                    his.type == 0
                                        ? $t('common.pro.clock_in.key_SGQD')
                                        : $t('common.pro.clock_in.key_SGQT')
                                }}：
                            </text>
                            <view class="pd-images" v-if="his.imgPath">
                                <view class="pd-image-box">
                                    <ImagePreview :images="BASEURL + his.imgPath" />
                                </view>
                            </view>
                        </view>
                    </view>
                </view>
            </scroll-view>
            <!-- <view class="history-wrap"> </view> -->
        </view>
    </view>
</template>

<script lang="ts" setup>
    import { ref, onMounted, onUnmounted, reactive, watch } from 'vue';
    import API from '@/apis/index';
    import { i18n } from '@/main';

    import ImagePreview from '@/components/ImagePreview/index.vue';
    import EmptyBox from '@/components/EmptyBox/index.vue';

    const BASEURL = import.meta.env.VITE_IMAGE_BASEURL;

    const props = defineProps<{
        projectId: string | number;
        projectStatus?: number;
    }>();

    // 打卡相关

    // 获取打卡记录回显数据

    const loadingText = ref('');
    const page = ref(1);
    const loading = ref(false); //
    const hasMore = ref(true); // 新增：是否还有更多数据
    const historyList = ref<any[]>([]);
    // 获取历史打卡记录
    const fetchHistory = async (reset = false) => {
        if (loading.value) return; // ✅ 防止重复加载
        loading.value = true;
        loadingText.value = i18n.global.t('common.loading');
        if (reset) {
            page.value = 1;
            historyList.value = [];
            hasMore.value = true; // 重置时认为还有更多，直到服务端返回判断
        }

        try {
            const res = await API.CUS_ProjectHistorySignInRecordList({
                id: props.projectId,
                pageNo: page.value,
            });
            const newData = res.data.list || [];

            if (newData.length < res.data.pageSize) {
                console.log('没有更多数据了');
                hasMore.value = false;
                loadingText.value = i18n.global.t('common.no-more');
            } else {
                console.log('上拉加载更多');
                hasMore.value = true;
                loadingText.value = i18n.global.t('common.release');
            }
            if (reset) {
                historyList.value = newData;
            } else {
                historyList.value.push(...newData);
            }

            console.log('历史打卡记录res', res);
        } catch (error) {
            console.log('error', error);
        } finally {
            loading.value = false;
        }
    };
    const onLoadMore = () => {
        if (!hasMore.value || loading.value) return;
        page.value++;
        fetchHistory();
    };

    watch(
        () => props.projectStatus,
        newVal => {
            if (newVal != 0) {
                //当状态不为0是代表项目已启动，就可以获取打卡记录了
                fetchHistory();
            }
        },
    );
</script>

<style lang="scss">
    .pd-punch {
        display: flex;
        flex-direction: column;
        height: 100%;
        .pd-punch-history {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;

            .cap-title {
                font-weight: 600;
                font-size: 32rpx;
                color: #303133;
                line-height: 45rpx;
                margin-bottom: 24rpx;
            }
            .history-wrap {
                background: #ffffff;
                border-radius: 24rpx;
                padding: 24rpx;
                box-sizing: border-box;
                flex: 1;
                overflow: auto;

                .pd-punch-history__item {
                    margin-bottom: 48rpx;
                    .pd-punch-history__time {
                        font-weight: 600;
                        font-size: 28rpx;
                        color: #303133;
                        line-height: 28rpx;
                        position: relative;
                        padding-left: 20rpx;
                        &::before {
                            content: ' ';
                            display: block;
                            width: 8rpx;
                            height: 8rpx;
                            background: #303133;
                            border-radius: 50%;
                            margin-right: 30rpx;
                            position: absolute;
                            left: 0;
                            top: 36%;
                        }
                    }
                    .pd-punch-history__people {
                        font-weight: 400;
                        font-size: 24rpx;
                        color: #909399;
                        line-height: 24rpx;
                    }
                    .punch-images {
                        margin-top: 24rpx;
                        .punch-image {
                            display: flex;
                            .label {
                                font-weight: 400;
                                font-size: 24rpx;
                                color: #303133;
                                line-height: 28rpx;
                            }
                            .pd-image-box {
                                width: 154rpx;
                                height: 154rpx;
                                border-radius: 8rpx;
                                overflow: hidden;
                                background: #f4f6f8;
                                .pd-image {
                                    width: 100%;
                                    height: 100%;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
</style>
