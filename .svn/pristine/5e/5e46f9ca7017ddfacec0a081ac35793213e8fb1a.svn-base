<!-- 施工选项卡 -->
<template>
    <view class="pd-construct">
        <!-- 工单状态切换按钮 -->
        <view class="pd-construct-set-wrap flex j-between a-center">
            <view class="pd-construct-state-btn">
                <view @click="tabChange(null)" class="state-btn" :class="tabType === null ? 'active' : ''">{{
                    $t('common.pro.state_0')
                }}</view>
                <view @click="tabChange(0)" class="state-btn" :class="tabType === 0 ? 'active' : ''">
                    {{ $t('common.pro.work_key_SGJL') }}
                </view>
                <view @click="tabChange(1)" class="state-btn" :class="tabType === 1 ? 'active' : ''">
                    {{ $t('common.pro.work_key_WTFK') }}
                </view>
            </view>
        </view>
        <!-- 工单列表 -->
        <scroll-view
            class="pd-construct-scroll-area common-scroll-area"
            scroll-y
            :show-scrollbar="false"
            :enhanced="true"
            :enable-back-to-top="true"
            @scrolltolower="loadMore"
        >
            <!-- 加载中 -->
            <view v-if="loading && page === 1" class="loading-box">
                <text class="loading-icon">⏳</text>
                <text class="loading-text">{{ $t('common.loading') }}</text>
            </view>

            <!-- 数据为空 -->
            <EmptyBox v-else-if="!loading && constructList.length === 0" />
            <view v-else>
                <view class="pd-construct-card" v-for="(item, index) in constructList" :key="index">
                    <view>
                        <view class="status-box" :class="getStatusClass(item.type).class"></view>
                        <view class="status-wrap">
                            <text class="status-text"> {{ getStatusClass(item.type).text }}</text>
                        </view>
                    </view>

                    <view class="pd-construct-id">{{ item.hardwareName }}</view>
                    <view class="label-value flex">
                        <text class="label">{{ $t('common.pro.work_key_SGRQ') }}：</text>
                        <view class="value">{{ item.buildTime }}</view>
                    </view>
                    <view class="label-value flex">
                        <text class="label"
                            >{{
                                item.type == 0 ? $t('common.pro.work_key_SGSM') : $t('common.pro.work_key_WTMS')
                            }}：</text
                        >
                        <view class="value">{{ item.instructions }}</view>
                    </view>
                    <view class="label-value flex" v-if="item.buildPath">
                        <text class="label">{{ $t('common.pro.work_key_SGJZT') }}：</text>
                        <ImagePreview :images="item.buildPath" />
                    </view>
                    <view class="label-value flex">
                        <text class="label">{{ $t('common.pro.work_key_GXR') }}：</text>
                        <view class="value">{{ item.workerName }}</view>
                    </view>
                    <view class="label-value flex">
                        <text class="label">{{ $t('common.pro.work_key_GXSJ') }}：</text>
                        <view class="value">{{ item.buildTime }}</view>
                    </view>
                </view>
                <!-- 底部加载状态 -->
                <view class="loading-text">{{ loadingText }}</view>
            </view>
        </scroll-view>
    </view>
</template>

<script lang="ts" setup>
    import API from '@/apis/index';
    import { i18n } from '@/main';
    import { ref, computed, watch, onMounted, reactive } from 'vue';
    import EmptyBox from '@/components/EmptyBox/index.vue';
    import ImagePreview from '@/components/ImagePreview/index.vue';

    const BASEURL = import.meta.env.VITE_IMAGE_BASEURL;

    const props = defineProps<{
        projectId: string | number;
    }>();

    const getStatusClass = (status: number): any => {
        switch (status) {
            case 0:
                return {
                    class: 'status-record',
                    text: i18n.global.t('common.pro.work_key_SGJL'),
                };
            case 1:
                return {
                    class: 'status-problem',
                    text: i18n.global.t('common.pro.work_key_WTFK'),
                };
        }
    };

    const tabType = ref<number | null>(null);
    const constructList = ref<any[]>([]);
    const page = ref(1);
    const loadingText = ref('');
    const refreshing = ref(false);
    const loading = ref(false); //
    const hasMore = ref(true); // 新增：是否还有更多数据
    const tabChange = (index: number | null) => {
        tabType.value = index;
        page.value = 1;
        fetchData(true);
    };
    // 获取施工记录列表
    const fetchData = async (reset = false) => {
        if (loading.value) return; // ✅ 防止重复加载
        loading.value = true;
        loadingText.value = i18n.global.t('common.loading');

        if (reset) {
            page.value = 1;
            constructList.value = [];
            hasMore.value = true; // 重置时认为还有更多，直到服务端返回判断
        }

        try {
            const res = await API.CUS_ProjectConstructionList({
                id: props.projectId,
                pageNo: page.value, //page.value
                type: tabType.value,
            });
            const newData = res.data.list || [];

            newData.forEach((item: any) => {
                item.buildPath = item.buildPath ? item.buildPath.split(',').map((item: any) => BASEURL + item) : '';
            });

            if (newData.length < res.data.pageSize) {
                console.log('没有更多数据了');
                hasMore.value = false;
                loadingText.value = i18n.global.t('common.no-more');
            } else {
                console.log('上拉加载更多');
                hasMore.value = true;
                loadingText.value = i18n.global.t('common.release');
            }

            if (reset) {
                console.log('列表结果reset', newData);
                constructList.value = newData;
            } else {
                constructList.value.push(...newData);
            }
            console.log('列表结果', constructList.value);
        } catch (error) {
            console.log('列表结果error', error);
        } finally {
            refreshing.value = false;
            loading.value = false;
        }
    };
    const loadMore = () => {
        if (!hasMore.value || loading.value) return;
        page.value++;
        fetchData();
    };

    fetchData();
</script>

<style lang="scss" scoped>
    .pd-construct {
        display: flex;
        flex-direction: column;
        height: 100%;
        .pd-construct-set-wrap {
            margin-bottom: 43rpx;
            align-items: center;
            .pd-construct-state-btn {
                display: flex;
                gap: 48rpx;
                .state-btn {
                    font-weight: 400;
                    font-size: 28rpx;
                    color: #909399;
                    &.active {
                        color: #f7931e;
                    }
                }
            }
        }
        .pd-construct-scroll-area {
            flex: 1;
            overflow: auto;
            box-sizing: border-box;

            .pd-construct-card {
                background: #ffffff;
                border-radius: 24rpx;
                padding: 24rpx;
                position: relative;
                overflow: hidden;
                & ~ .pd-construct-card {
                    margin-top: 24rpx;
                }
                .status-box {
                    position: absolute;
                    top: -4rpx;
                    right: -4rpx;
                    color: #999;
                    width: 242rpx;
                    height: 82rpx;
                    z-index: 1;
                    &.status-record {
                        background-color: #303133;
                    }
                    &.status-problem {
                        background-color: #f7931e;
                    }
                }
                .status-wrap {
                    position: absolute;
                    top: 0;
                    right: 0;
                    font-size: 26rpx;
                    color: #999;
                    width: 242rpx;
                    height: 82rpx;
                    // background-color: #303133;
                    background-image: url('@/assets/images/index-state-bg.png');
                    background-size: 100% 100%;
                    z-index: 2;

                    .status-text {
                        display: block;
                        text-align: center;
                        font-weight: 400;
                        font-size: 28rpx;
                        color: #ffffff;
                        margin-top: 6rpx;
                        margin-left: 40rpx;
                    }
                }
                .pd-construct-id {
                    font-weight: 600;
                    font-size: 32rpx;
                    color: #303133;
                    margin-bottom: 24rpx;
                }
                .label-value {
                    font-weight: 400;
                    font-size: 28rpx;
                    color: #909399;
                    & ~ .label-value {
                        margin-top: 24rpx;
                    }
                    .label {
                        flex-shrink: 0;
                    }
                }
            }
        }
    }
</style>
