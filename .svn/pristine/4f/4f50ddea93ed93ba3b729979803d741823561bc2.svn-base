<template>
    <view class="card-swiper" :style="{ height }">
        <swiper
            class="swiper"
            circular
            :autoplay="autoplay"
            :interval="interval"
            :duration="duration"
            :current="current"
            previous-margin="68px"
            next-margin="68px"
            @change="onChange"
        >
            <swiper-item v-for="(it, i) in items" :key="i" class="swiper-item" @click="onClick(i, it)">
                <view class="card" :class="{ active: i === current }">
                    <image class="cover" :src="it.img" mode="aspectFill" />
                    <view class="tag">
                        <text class="tag-text">{{ it.title }}</text>
                    </view>
                </view>
            </swiper-item>
        </swiper>
    </view>
</template>

<script setup lang="ts">
    import { ref, watch, defineProps, defineEmits } from 'vue';

    type Item = { img: string; title?: string };

    const props = withDefaults(
        defineProps<{
            items: Item[];
            /** 轮播高度（带单位） */
            height?: string;
            autoplay?: boolean;
            interval?: number;
            duration?: number;
            modelValue?: number;
        }>(),
        {
            height: '420rpx',
            autoplay: false,
            interval: 3500,
            duration: 400,
            modelValue: 0,
        },
    );

    const emit = defineEmits<{
        (e: 'update:modelValue', v: number): void;
        (e: 'change', v: number): void;
        (e: 'select', payload: { index: number; item: Item }): void;
    }>();

    const current = ref(props.modelValue);
    watch(
        () => props.modelValue,
        v => (current.value = v),
    );
    const onChange = (e: any) => {
        current.value = e.detail.current;
        emit('update:modelValue', current.value);
        emit('change', current.value);
    };
    const onClick = (i: number, it: Item) => {
        emit('select', { index: i, item: it });
    };
</script>

<style scoped lang="scss">
    .card-swiper {
        width: 100%;
        overflow-x: hidden;
        .swiper {
            width: 100%;
            height: 100%;
        }
        :deep(.uni-swiper-wrapper),
        :deep(.uni-swiper-slides) {
            overflow: visible !important;
        }
        .swiper-item {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            width: 94%;
            height: 100%;
            border-radius: 24rpx;
            overflow: hidden;
            transform: scale(0.9);
            opacity: 0.7;
            transition: transform 0.28s ease, opacity 0.28s ease, box-shadow 0.28s ease;
            box-shadow: 0 8rpx 20rpx rgba(0, 0, 0, 0.06);

            &.active {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 12rpx 28rpx rgba(0, 0, 0, 0.12);
            }

            .cover {
                width: 100%;
                height: 100%;
                display: block;
            }

            .tag {
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
                height: 68rpx;
                padding: 0 24rpx;
                display: flex;
                align-items: center;
                background: linear-gradient(0deg, rgba(247, 147, 30, 0.8), rgba(247, 147, 30, 0.6));
                /* 只给底部圆角 */
                border-bottom-left-radius: 24rpx;
                border-bottom-right-radius: 24rpx;

                .tag-text {
                    color: #fff;
                    font-size: 28rpx;
                    font-weight: 600;
                }
            }
        }
    }
</style>
