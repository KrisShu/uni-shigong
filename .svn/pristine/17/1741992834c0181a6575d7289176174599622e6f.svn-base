<template>
    <view class="website-page">
        <!-- 顶部导航 -->
        <view class="header" :class="{ 'with-shadow': hasShadow }">
            <image src="../../assets/images/website/logo2.png" class="logo" />
            <view class="nav-list">
                <view @click="changeTab(1)" class="nav-item nav-item1" :class="{ active: curTab === 1 }">Home</view>
                <view @click="changeTab(2)" class="nav-item nav-item2" :class="{ active: curTab === 2 }">About</view>
                <view @click="changeTab(3)" class="nav-item nav-item3" :class="{ active: curTab === 3 }">Projects</view>
                <view class="active-line" :style="{ left: underlineLeft }"></view>
            </view>
        </view>

        <!-- Home -->
        <view class="chunk Home-wrap">
            <view class="image-box">
                <image class="img" :src="webSiteInfo.banner" mode="aspectFit" lazy-load></image>
            </view>
        </view>

        <!-- About -->
        <view class="chunk about-us-wrap">
            <view class="title">
                <text class="text">About</text>
                <text class="title-line"></text>
            </view>
            <view class="content-wrap">
                <rich-text :nodes="webSiteInfo.introduce"></rich-text>
            </view>
        </view>

        <!-- Projects -->
        <view class="chunk our-projects-wrap">
            <view class="title">
                <text class="text">Projects</text>
                <text class="title-line"></text>
            </view>
            <view class="swiper-wrap">
                <CardCarousel
                    v-model="cur"
                    :items="webSiteInfo.caseList"
                    height="722rpx"
                    :autoplay="true"
                    :interval="3800"
                />
            </view>
        </view>

        <!-- 底部 -->
        <view class="bottom-wrap">
            <view class="form-item">
                <view class="label">Contact：</view>
                <view class="value width">{{ webSiteInfo.name }}</view>
            </view>
            <view class="form-item">
                <view class="label">Phone：</view>
                <view class="value width">{{ webSiteInfo.phone }}</view>
            </view>
            <view class="form-item">
                <view class="label">Email：</view>
                <view class="value width">{{ webSiteInfo.email }}</view>
            </view>
            <view class="form-item">
                <view class="label">CompanyName：</view>
                <view class="value">{{ webSiteInfo.companyName }}</view>
            </view>
            <view class="form-item">
                <view class="label">Address：</view>
                <view class="value">{{ webSiteInfo.address }}</view>
            </view>

            <image src="../../assets/images/website/logo1.png" mode="aspectFill" class="logo"></image>
        </view>

        <!-- 漂浮登录按钮（可删） -->
        <movable-area class="bg">
            <movable-view :x="x" :y="y" direction="all">
                <view @click="toLogin" class="login-btn">Login</view>
            </movable-view>
            <movable-view :x="x2" :y="y2" direction="all">
                <view @click="toCall" class="call-btn">
                    <image src="../../assets/images/website/call.png" mode="aspectFill" class="call-img"></image>
                </view>
            </movable-view>
        </movable-area>
    </view>
</template>

<script lang="ts" setup>
    import { ref, reactive, onMounted, onUnmounted } from 'vue';
    import CardCarousel from './CardCarousel.vue';
    import API from '@/apis/index';

    /** ================= 数据区 ================= **/
    const x = ref(0);
    const y = ref(560);
    const x2 = ref(0);
    const y2 = ref(500);

    const cur = ref(0); // 轮播索引

    const curTab = ref(1); // 当前激活导航
    const underlineLeft = ref('10rpx'); // 导航条位置

    const webSiteInfo = reactive<any>({
        introduce: '',
        banner: '',
        name: '',
        phone: '',
        email: '',
        companyName: '',
        address: '',
        caseList: [],
    });
    const BASEURL = import.meta.env.VITE_IMAGE_BASEURL;

    const sectionSelectors = ['.Home-wrap', '.about-us-wrap', '.our-projects-wrap'] as const;
    const headerOffset = 80; // 顶部吸顶 header 的高度（用于对齐目标位置）
    const PROTECT_MS = 500; // 程序化滚动保护期（避免被 scroll 回调改回去）

    /** 阴影 + 节流开关 */
    const hasShadow = ref(false);
    let ticking = false;

    /** 程序化滚动保护相关 */
    let isProgrammaticScroll = false;
    let programmaticTimer: number | null = null;
    let lastProgrammaticAt = 0;

    /** ================= 工具函数 ================= **/
    function setUnderline(index: number) {
        // 你原来的“像素定位”逻辑：1 -> 2rpx, 2 -> 32rpx, 3 -> 78rpx
        if (index === 1) underlineLeft.value = '10rpx';
        else if (index === 2) underlineLeft.value = '40%';
        else underlineLeft.value = '80%';
    }

    function setActiveTabByIndex(i: number) {
        const target = i + 1;
        if (curTab.value !== target) {
            curTab.value = target;
            setUnderline(target);
        }
    }

    /** 获取（近似）页面总高度，H5 下优先用 DOM */
    function getPageHeightSync(): number {
        if (typeof document !== 'undefined') {
            const de = document.documentElement;
            const b = document.body;
            return Math.max(de.scrollHeight, b.scrollHeight);
        }
        return 0;
    }

    /** 夹紧滚动位置，避免超出页面高度导致“滚不到 Projects 就到底了”的错觉 */
    function clampScrollTopSync(want: number): number {
        let pageH = getPageHeightSync();
        if (!pageH && typeof uni !== 'undefined') {
            // 兜底：用 selector 获取根节点高度
            try {
                const sys = uni.getSystemInfoSync();
                const windowH = sys.windowHeight || 0;
                // 粗略估计，不阻塞：让它“至少不会超出窗口太多”
                pageH = windowH * 2;
            } catch {}
        }
        if (!pageH) return Math.max(0, want);
        if (typeof window !== 'undefined') {
            const sys = uni.getSystemInfoSync();
            const winH = sys.windowHeight || 0;
            const maxTop = Math.max(0, pageH - winH);
            return Math.min(Math.max(0, want), maxTop);
        }
        return Math.max(0, want);
    }

    /** ================= 导航点击：程序化滚动 ================= **/
    function changeTab(index: number) {
        curTab.value = index;
        setUnderline(index);

        const map: Record<number, string> = {
            1: '.Home-wrap',
            2: '.about-us-wrap',
            3: '.our-projects-wrap',
        };
        const targetSel = map[index];
        if (!targetSel) return;

        // 标记程序化滚动
        isProgrammaticScroll = true;
        lastProgrammaticAt = Date.now();
        if (programmaticTimer) clearTimeout(programmaticTimer);

        // 先拿当前 scrollTop
        const q1 = uni.createSelectorQuery();
        q1.selectViewport()
            .scrollOffset((vp: any) => {
                const currentTop = vp?.scrollTop ?? 0;

                // 再用“新的实例”查询目标 rect，避免复用导致递归
                const q2 = uni.createSelectorQuery();
                q2.select(targetSel)
                    .boundingClientRect((rect: any) => {
                        if (!rect) {
                            programmaticTimer = window.setTimeout(() => {
                                isProgrammaticScroll = false;
                                programmaticTimer = null;
                            }, PROTECT_MS);
                            return;
                        }
                        const wantTop = currentTop + rect.top - headerOffset + 1;
                        const finalTop = clampScrollTopSync(wantTop);
                        const duration = 350;
                        uni.pageScrollTo({ scrollTop: finalTop, duration });
                        programmaticTimer = window.setTimeout(() => {
                            isProgrammaticScroll = false;
                            programmaticTimer = null;
                        }, duration + 150);
                    })
                    .exec();
            })
            .exec();
    }

    /** ================= 滚动联动（高亮/阴影） ================= **/
    function handleScroll() {
        // 阴影
        let scrollY = 0;
        if (typeof window !== 'undefined') {
            scrollY = window.scrollY ?? document.documentElement.scrollTop ?? 0;
        }
        hasShadow.value = scrollY > 70;

        // 程序化保护期：不做联动
        const now = Date.now();
        if (now - lastProgrammaticAt < PROTECT_MS) return;
        if (isProgrammaticScroll) return;

        if (ticking) return;
        ticking = true;

        requestAnimationFrame(() => {
            try {
                // 先拿 viewport 信息（新的实例）
                const qVp = uni.createSelectorQuery();
                qVp.selectViewport()
                    .scrollOffset((vp: any) => {
                        const viewportTop = vp?.scrollTop ?? 0;
                        const sys = uni.getSystemInfoSync();
                        const windowH = sys.windowHeight || 0;
                        const pageBottom = viewportTop + windowH;

                        // 再查询各 section 的 rect（新的实例）
                        const qRects = uni.createSelectorQuery();
                        qRects
                            .selectAll(sectionSelectors.join(','))
                            .boundingClientRect((rects: any[]) => {
                                if (!rects || rects.length === 0) return;

                                // 页面总高（优先 DOM，同步算）
                                const docH = getPageHeightSync();

                                // 若已“几乎”抵达底部，则高亮最后一个
                                if (docH && Math.abs(pageBottom - docH) <= 2) {
                                    setActiveTabByIndex(rects.length - 1);
                                    return;
                                }

                                // 常规：用 header 底部作为“参考线”
                                const headerLine = headerOffset;
                                let idx = -1;
                                for (let i = 0; i < rects.length; i++) {
                                    const r = rects[i];
                                    if (!r) continue;
                                    // 优先 bottom 穿过参考线
                                    if (r.bottom <= headerLine + 2) {
                                        idx = i;
                                        continue;
                                    }
                                    // 或 top 穿过参考线
                                    if (r.top <= headerLine) {
                                        idx = i;
                                    }
                                }
                                if (idx < 0) idx = 0;
                                setActiveTabByIndex(idx);
                            })
                            .exec();
                    })
                    .exec();
            } finally {
                ticking = false;
            }
        });
    }

    /** ================= 业务与生命周期 ================= **/
    async function fetchData() {
        const res = await API.websiteAPI();
        Object.assign(webSiteInfo, res.data || {});
        webSiteInfo.banner = webSiteInfo.banner ? BASEURL + webSiteInfo.banner : '';
        webSiteInfo.caseList = (webSiteInfo.caseList || []).map((it: any) => ({
            ...it,
            img: BASEURL + it.filePath,
        }));
    }

    function toLogin() {
        uni.navigateTo({ url: '/pages/login/index' });
    }

    function toCall() {
        if (!webSiteInfo.phone) return;
        console.log('toCall', webSiteInfo.phone);
        uni.makePhoneCall({
            phoneNumber: webSiteInfo.phone, //仅为示例
        });
    }

    onMounted(() => {
        if (typeof window !== 'undefined') {
            window.addEventListener('scroll', handleScroll, { passive: true });
            setTimeout(handleScroll, 80); // 初始触发一次
        }
        fetchData();
    });

    onUnmounted(() => {
        if (typeof window !== 'undefined') {
            window.removeEventListener('scroll', handleScroll);
        }
        if (programmaticTimer) {
            clearTimeout(programmaticTimer);
            programmaticTimer = null;
        }
    });
</script>

<style lang="scss" scoped>
    .website-page {
        padding-top: 96rpx;

        .header {
            background-color: #fff;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10rpx 24rpx;
            box-sizing: border-box;

            &.with-shadow {
                box-shadow: 0 6rpx 10rpx rgba(0, 0, 0, 0.2);
            }

            .logo {
                width: 153rpx;
                height: 68rpx;
            }

            .nav-list {
                display: flex;
                gap: 48rpx;
                position: relative;

                .nav-item {
                    font-weight: 400;
                    font-size: 28rpx;
                    color: #909399;
                    line-height: 40rpx;
                    text-align: center;

                    &.nav-item1 {
                        width: 80rpx;
                    }
                    &.nav-item2 {
                        width: 100rpx;
                    }
                    &.nav-item3 {
                        width: 100rpx;
                    }

                    &.active {
                        color: #303133;
                        font-weight: 600;
                    }
                }

                .active-line {
                    position: absolute;
                    width: 56rpx;
                    height: 4rpx;
                    background-color: #f7931e;
                    top: 50rpx;
                    transition: left 0.25s ease;
                }
            }
        }

        .Home-wrap {
            height: 1076rpx;
            background-color: #fff;
            .image-box {
                width: 100%;
                height: 100%;
                .img {
                    width: 100%;
                    height: 100%;
                }
            }
        }

        .about-us-wrap,
        .our-projects-wrap {
            padding-top: 64rpx;
            background-color: #fff;
            position: relative;
            z-index: 2;

            .title {
                position: relative;
                height: 44rpx;
                margin-bottom: 42rpx;

                .text {
                    font-weight: 600;
                    font-size: 36rpx;
                    color: #303133;
                    line-height: 32rpx;
                    text-align: center;
                    display: block;
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 2;
                }
                .title-line {
                    display: block;
                    width: 72rpx;
                    height: 8rpx;
                    border-radius: 10rpx;
                    background-color: #f7931e;
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                    bottom: 10rpx;
                }
            }
        }

        .about-us-wrap {
            .content-wrap {
                padding: 0 32rpx;
                box-sizing: border-box;
                overflow: hidden;
                img {
                    width: 100% !important;
                    height: auto !important;
                }
                p {
                    min-height: 24rpx;
                }
            }
        }

        .bottom-wrap {
            background: #303133;
            padding: 40rpx 32rpx;
            margin-top: 64rpx;
            position: relative;
            color: #fff;

            .form-item {
                display: flex;
                font-size: 24rpx;
                line-height: 36rpx;

                & + .form-item {
                    margin-top: 36rpx;
                }
                .value {
                    word-break: break-all;
                    white-space: pre-wrap;
                    &.width {
                        width: 46%;
                    }
                }
                .label {
                    padding-left: 48rpx;
                    position: relative;
                    height: 36rpx;
                    &::before {
                        content: '';
                        display: inline-block;
                        width: 36rpx;
                        height: 36rpx;
                        background-image: url('@/assets/images/website/icon4.png');
                        background-size: cover;
                        position: absolute;
                        left: 0;
                    }
                }
                &:nth-of-type(2) .label::before {
                    background-image: url('@/assets/images/website/icon3.png');
                }
                &:nth-of-type(3) .label::before {
                    background-image: url('@/assets/images/website/iocn5.png');
                }
                &:nth-of-type(4) .label::before {
                    background-image: url('@/assets/images/website/iocn2.png');
                }
                &:nth-of-type(5) .label::before {
                    background-image: url('@/assets/images/website/icon1.png');
                }
            }
            .logo {
                position: absolute;
                width: 188rpx;
                height: 98rpx;
                top: 40rpx;
                right: 32rpx;
            }
        }

        .bg {
            background-color: transparent;
            height: 90%;
            width: 100rpx;
            position: fixed;
            bottom: 0;
            right: 0;
            z-index: 5;
        }
        .login-btn {
            width: 88rpx;
            height: 88rpx;
            border-radius: 50%;
            background: #f7931e;
            color: #fff;
            text-align: center;
            line-height: 88rpx;
            box-shadow: 0 0 9rpx 0 #f7931e;
            font-weight: 600;
            font-size: 24rpx;
        }
        .call-btn {
            width: 88rpx;
            height: 88rpx;
            background: #ffffff;
            box-shadow: 0rpx 0rpx 9rpx 0rpx rgba(247, 147, 30, 0.51);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            .call-img {
                width: 44rpx;
                height: 44rpx;
            }
        }
    }
</style>
